<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSC PYQs by Daily Intellect</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <meta name="theme-color" content="#2563eb">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; padding-bottom: 80px; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        try {
            // --- 0. PWA REGISTRATION ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail', err));
                });
            }

            // --- 1. CONFIGURATION ---
            const SUPABASE_URL = "https://lkwciklwwssrwzgecrvv.supabase.co";
            const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrd2Npa2x3d3Nzcnd6Z2VjcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjAwNjYsImV4cCI6MjA4NDUzNjA2Nn0.l-M24USVWXR_WOJLP0vP3MtXfCsllU9n1VXOau9JN8A";
            
            const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { useState, useEffect, useRef } = React;

            // --- 2. ICON HELPER ---
            const Icon = ({ name, size = 24, className = "" }) => {
                const iconRef = useRef(null);
                useEffect(() => {
                    if (iconRef.current && window.lucide && window.lucide.icons && window.lucide.icons[name]) {
                        const iconDef = window.lucide.icons[name];
                        iconRef.current.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
                                ${iconDef.map(child => `<${child[0]} ${Object.entries(child[1]).map(([k, v]) => `${k}="${v}"`).join(' ')} />`).join('')}
                            </svg>`;
                    }
                }, [name, size, className]);
                return <span ref={iconRef} className="inline-flex items-center justify-center" />;
            };

            // --- 3. DATA & UTILS ---
            const TOPICS = {
                "Quantitative Aptitude": {
                    timerRange: { min: 40, max: 60 },
                    subtopics: ["Computation of whole numbers", "Decimals", "Fractions", "Relationships between numbers", "Profit and Loss", "Discount", "Partnership Business", "Mixture and Alligation", "Time and distance", "Time & Work", "Percentage", "Ratio & Proportion", "Square roots", "Averages", "Interest", "Basic algebraic identities", "Graphs of Linear Equations", "Triangle centres", "Congruence and similarity", "Circles (chords, tangents)", "Common tangents", "Quadrilaterals", "Regular Polygons", "Right Prism", "Right Circular Cone", "Right Circular Cylinder", "Sphere", "Heights and Distances", "Histogram", "Frequency polygon", "Bar diagram & Pie chart", "Hemispheres", "Rectangular Parallelepiped", "Right Pyramid", "Trigonometric ratio", "Degree and Radian", "Standard Identities", "Complementary angles"]
                },
                "General Intelligence and Reasoning": {
                    timerRange: { min: 20, max: 30 },
                    subtopics: ["Analogies", "Similarities and differences", "Space visualization", "Spatial orientation", "Problem-solving", "Analysis", "Judgment", "Blood Relations", "Decision making", "Visual memory", "Discrimination", "Observation", "Relationship concepts", "Arithmetical reasoning", "Figural classification", "Arithmetic number series", "Non-verbal series", "Coding and decoding", "Statement conclusion", "Syllogistic reasoning"]
                },
                "English Language": {
                    timerRange: { min: 20, max: 30 },
                    subtopics: ["Idioms and Phrases", "One word Substitution", "Sentence Correction", "Error Spotting", "Fill in the Blanks", "Spellings Correction", "Reading Comprehension", "Synonyms-Antonyms", "Active Passive", "Sentence Rearrangement", "Sentence Improvement", "Cloze test"]
                },
                "General Awareness": {
                    timerRange: { min: 10, max: 20 },
                    subtopics: ["Economic Scene", "India and its neighbouring countries", "History", "Culture", "Geography", "General Policy & polity", "Scientific Research", "Science", "Current Affairs", "Books and Authors", "Sports", "Important Schemes", "Important Days", "Portfolio", "People in News", "Static GK"]
                }
            };

            const normalizeText = (text) => (text || "").trim().toLowerCase();

            // --- FIX: Round intervals to Integers to prevent DB Errors ---
            const calculateSM2 = (quality, prevEf, prevRepetitions, prevInterval) => {
                let nextEf = prevEf + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                if (nextEf < 1.3) nextEf = 1.3;
                
                let nextRepetitions = quality < 3 ? 0 : prevRepetitions + 1;
                let nextInterval;
                
                if (quality < 3) { 
                    nextInterval = 0; // Fail -> Immediate
                } else {
                    if (prevRepetitions === 0) {
                        // FIX: Changed 0.5 to 1 to ensure Integer compatibility
                        if (quality === 3) nextInterval = 1;      // Hard -> 1 day
                        else if (quality === 4) nextInterval = 2; // Good -> 2 days
                        else if (quality === 5) nextInterval = 4; // Easy -> 4 days
                    } else {
                        if (prevRepetitions === 1 && quality === 3) nextInterval = 2; 
                        else if (prevRepetitions === 1 && quality === 4) nextInterval = 3;
                        else nextInterval = Math.round(prevInterval * nextEf); // FIX: Ensure round
                    }
                }
                // Safety clamp
                if (nextInterval < 1 && quality >= 3) nextInterval = 1;
                
                return { ef: nextEf, reps: nextRepetitions, interval: nextInterval };
            };

            // --- 5. COMPONENTS ---

            const Auth = ({ onLogin }) => {
                const [view, setView] = useState('login'); 
                const [loading, setLoading] = useState(false);
                const [formData, setFormData] = useState({ username: '', password: '', recoveryQ: '', recoveryA: '', newPassword: '' });
                const [fetchedQuestion, setFetchedQuestion] = useState(null);
                const [error, setError] = useState('');

                const handleLogin = async (e) => {
                    e.preventDefault(); setLoading(true); setError('');
                    try {
                        const { data, error } = await supabase.from('users').select('*').eq('username', formData.username).eq('password', formData.password).single();
                        if (error || !data) throw new Error("Invalid username or password");
                        onLogin(data);
                    } catch (err) { setError(err.message); } finally { setLoading(false); }
                };
                const handleSignup = async (e) => {
                    e.preventDefault(); setLoading(true); setError('');
                    try {
                        const { data: existing } = await supabase.from('users').select('id').eq('username', formData.username).single();
                        if (existing) throw new Error("Username already taken");
                        const { data, error } = await supabase.from('users').insert([{ username: formData.username, password: formData.password, recovery_question: formData.recoveryQ, recovery_answer: formData.recoveryA }]).select().single();
                        if (error) throw error;
                        alert("Account created successfully!");
                        onLogin(data);
                    } catch (err) { setError(err.message); } finally { setLoading(false); }
                };
                const handleFetchQuestion = async (e) => {
                    e.preventDefault(); setLoading(true); setError('');
                    try {
                        const { data, error } = await supabase.from('users').select('recovery_question').eq('username', formData.username).single();
                        if (error || !data) throw new Error("User not found");
                        setFetchedQuestion(data.recovery_question);
                    } catch (err) { setError(err.message); } finally { setLoading(false); }
                };
                const handleResetPassword = async (e) => {
                    e.preventDefault(); setLoading(true); setError('');
                    try {
                        const { data, error } = await supabase.from('users').update({ password: formData.newPassword }).eq('username', formData.username).eq('recovery_answer', formData.recoveryA).select();
                        if (error) throw error;
                        if (data.length === 0) throw new Error("Incorrect Recovery Answer");
                        alert("Password reset successfully! Please login.");
                        setView('login'); setFetchedQuestion(null); setFormData({...formData, password: '', recoveryA: '', newPassword: ''});
                    } catch (err) { setError(err.message); } finally { setLoading(false); }
                };

                return (
                    <div className="min-h-screen flex items-center justify-center bg-blue-50 p-4">
                        <div className="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 border border-blue-100">
                            <div className="text-center mb-6">
                                <h2 className="text-blue-600 font-bold tracking-widest text-sm mb-2">DAILY INTELLECT</h2>
                                <h1 className="text-2xl font-bold text-slate-800">{view === 'login' ? 'Welcome Back' : view === 'signup' ? 'Create Account' : 'Reset Password'}</h1>
                                {error && <p className="text-red-500 text-sm mt-2 bg-red-50 p-2 rounded">{error}</p>}
                            </div>
                            {view === 'login' && (
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <input required placeholder="Username" type="text" className="w-full p-3 border rounded-lg" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                                    <input required placeholder="Password" type="password" className="w-full p-3 border rounded-lg" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                                    <button disabled={loading} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">{loading ? '...' : 'Login'}</button>
                                    <div className="text-center text-sm space-y-2 mt-4"><button type="button" onClick={() => setView('signup')} className="text-blue-600 block w-full hover:underline">Create New Account</button><button type="button" onClick={() => { setView('forgot'); setError(''); }} className="text-slate-400 hover:text-slate-600">Forgot Password?</button></div>
                                </form>
                            )}
                            {view === 'signup' && (
                                <form onSubmit={handleSignup} className="space-y-4">
                                    <input required placeholder="Username" type="text" className="w-full p-3 border rounded-lg" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                                    <input required placeholder="Password" type="password" className="w-full p-3 border rounded-lg" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                                    <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Security Question</label>
                                        <input required placeholder="Question (e.g. First pet?)" type="text" className="w-full p-3 border rounded-lg mb-2" value={formData.recoveryQ} onChange={e => setFormData({...formData, recoveryQ: e.target.value})} />
                                        <input required placeholder="Answer (e.g. Fluffy)" type="text" className="w-full p-3 border rounded-lg" value={formData.recoveryA} onChange={e => setFormData({...formData, recoveryA: e.target.value})} />
                                    </div>
                                    <button disabled={loading} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">{loading ? '...' : 'Sign Up'}</button><button type="button" onClick={() => setView('login')} className="w-full text-slate-500 text-sm mt-2 hover:underline">Back to Login</button>
                                </form>
                            )}
                            {view === 'forgot' && (
                                <div className="space-y-4">
                                    {!fetchedQuestion ? (
                                        <form onSubmit={handleFetchQuestion} className="space-y-4">
                                            <p className="text-sm text-slate-600 text-center">Enter your username to find your account.</p>
                                            <input required placeholder="Username" type="text" className="w-full p-3 border rounded-lg" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                                            <button disabled={loading} className="w-full bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900">{loading ? 'Searching...' : 'Find Account'}</button>
                                        </form>
                                    ) : (
                                        <form onSubmit={handleResetPassword} className="space-y-4">
                                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100 text-blue-800 text-sm font-medium text-center">{fetchedQuestion}</div>
                                            <input required placeholder="Your Answer" type="text" className="w-full p-3 border rounded-lg" value={formData.recoveryA} onChange={e => setFormData({...formData, recoveryA: e.target.value})} />
                                            <input required placeholder="New Password" type="password" className="w-full p-3 border rounded-lg" value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})} />
                                            <button disabled={loading} className="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700">{loading ? 'Updating...' : 'Reset Password'}</button>
                                        </form>
                                    )}
                                    <button onClick={() => { setView('login'); setFetchedQuestion(null); }} className="w-full text-slate-400 text-sm hover:text-slate-600">Cancel</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const Home = ({ user, onSelectTopic, onLogout, globalSrMode, setGlobalSrMode }) => {
                const username = user.username || "Learner";
                return (
                    <div className="min-h-screen bg-slate-50">
                        <header className="bg-white shadow-sm sticky top-0 z-10">
                            <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <Icon name="BookOpen" className="text-blue-600" size={24} />
                                    <h1 className="font-bold text-lg text-blue-900 tracking-wide hidden md:block">SSC PYQS BY DAILY INTELLECT</h1>
                                </div>
                                <button onClick={onLogout} className="p-2 text-slate-400 hover:text-red-500 transition-colors"><Icon name="LogOut" size={20} /></button>
                            </div>
                        </header>
                        <div className="max-w-7xl mx-auto px-4 py-6">
                            <div className="flex flex-col md:flex-row justify-between items-center bg-blue-600 rounded-xl p-6 text-white shadow-lg mb-8">
                                <div><h2 className="text-2xl font-bold">Hello, {username}!</h2><p className="text-blue-100 opacity-90">Ready to crush your goals today?</p></div>
                                <div className="flex items-center gap-4 mt-4 md:mt-0">
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm font-medium">Spaced Repetition</span>
                                        <button onClick={() => setGlobalSrMode(!globalSrMode)} className={`w-12 h-6 rounded-full p-1 transition-colors ${globalSrMode ? 'bg-green-400' : 'bg-slate-400'}`}>
                                            <div className={`w-4 h-4 bg-white rounded-full shadow-md transform transition-transform ${globalSrMode ? 'translate-x-6' : ''}`}></div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                                {Object.keys(TOPICS).map((topic) => (
                                    <button key={topic} onClick={() => onSelectTopic(topic)} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-200 transition-all text-left group relative overflow-hidden">
                                        <div className="flex justify-between items-center mb-4 relative z-10">
                                            <div className="p-3 bg-blue-50 rounded-lg text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                                {topic === 'Quantitative Aptitude' && <Icon name="Zap" size={24} />}
                                                {topic === 'General Intelligence and Reasoning' && <Icon name="Clock" size={24} />}
                                                {topic === 'English Language' && <Icon name="BookOpen" size={24} />}
                                                {topic === 'General Awareness' && <Icon name="CheckCircle" size={24} />}
                                            </div>
                                            <div className="text-slate-300 group-hover:text-blue-600"><Icon name="ChevronRight" /></div>
                                        </div>
                                        <h3 className="font-bold text-lg text-slate-800 relative z-10">{topic}</h3>
                                        <p className="text-sm text-slate-500 mt-1 relative z-10">{TOPICS[topic].subtopics.length} Subtopics</p>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const SubtopicView = ({ topic, globalSrMode, setGlobalSrMode, onBack, onStartWorkout, user }) => {
                const [timerEnabled, setTimerEnabled] = useState(() => {
                    const saved = localStorage.getItem('ssc_timer_enabled');
                    return saved !== null ? JSON.parse(saved) : true;
                });

                const [timerValue, setTimerValue] = useState(() => {
                    const saved = localStorage.getItem(`ssc_timer_value_${topic}`);
                    const val = saved ? parseInt(saved) : TOPICS[topic].timerRange.min;
                    return (val >= TOPICS[topic].timerRange.min && val <= TOPICS[topic].timerRange.max) 
                        ? val 
                        : TOPICS[topic].timerRange.min;
                });
                
                useEffect(() => {
                    localStorage.setItem('ssc_timer_enabled', JSON.stringify(timerEnabled));
                }, [timerEnabled]);

                useEffect(() => {
                    localStorage.setItem(`ssc_timer_value_${topic}`, timerValue);
                }, [timerValue, topic]);

                const [topicStats, setTopicStats] = useState({});
                const [loadingStats, setLoadingStats] = useState(true);

                useEffect(() => {
                    const fetchTopicStats = async () => {
                        setLoadingStats(true);
                        let qData = [];
                        const { data: d1 } = await supabase.from('questions').select('id, subtopic').eq('topic', topic).limit(5000);
                        if(d1 && d1.length > 0) qData = d1;
                        if(qData.length === 0) {
                             const { data: d2 } = await supabase.from('questions').select('id, subtopic').limit(5000); 
                             qData = d2 || []; 
                        }

                        const qIds = qData.map(q => q.id);
                        if (qIds.length === 0) { setTopicStats({}); setLoadingStats(false); return; }

                        const { data: prog } = await supabase.from('user_progress').select('question_id, next_review').eq('user_id', user.id).in('question_id', qIds);
                        
                        // FIX: Ensure ID matching matches string/int correctly
                        const progMap = {};
                        (prog || []).forEach(p => progMap[String(p.question_id)] = p);
                        
                        const newStats = {};
                        const now = new Date();

                        qData.forEach(q => {
                            if (!q.subtopic) return;
                            const subKey = normalizeText(q.subtopic);
                            if (!newStats[subKey]) newStats[subKey] = { new: 0, due: 0 };
                            
                            const p = progMap[String(q.id)];
                            if (!p) newStats[subKey].new += 1;
                            else if (new Date(p.next_review) <= now) newStats[subKey].due += 1;
                        });
                        setTopicStats(newStats);
                        setLoadingStats(false);
                    };
                    fetchTopicStats();
                }, [topic, user.id]);

                const getProgress = (sub) => { const key = `progress_${user.id}_${sub}`; return parseInt(localStorage.getItem(key)) || 0; };
                const resetProgress = (e, sub) => {
                    e.stopPropagation(); const key = `progress_${user.id}_${sub}`; localStorage.setItem(key, 0);
                    setTopicStats({...topicStats});
                };

                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col">
                        <div className="bg-white shadow-sm p-4 sticky top-0 z-20">
                            <button onClick={onBack} className="flex items-center gap-1 text-slate-500 hover:text-blue-600 mb-2"><Icon name="ChevronLeft" size={16} /> Back to Dashboard</button>
                            <h2 className="text-xl font-bold text-blue-900">{topic}</h2>
                        </div>
                        <div className="max-w-4xl mx-auto w-full p-4 flex-grow">
                            <div className="bg-white rounded-xl shadow-sm p-5 mb-6 border border-slate-100">
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-sm font-semibold text-slate-700 flex items-center gap-2"><Icon name="Clock" size={16} /> Timer ({timerValue}s)</span>
                                            <button onClick={() => setTimerEnabled(!timerEnabled)} className={`text-xs font-bold px-2 py-1 rounded ${timerEnabled ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-500'}`}>{timerEnabled ? 'ON' : 'OFF'}</button>
                                        </div>
                                        <input type="range" min={TOPICS[topic].timerRange.min} max={TOPICS[topic].timerRange.max} value={timerValue} onChange={(e) => setTimerValue(e.target.value)} disabled={!timerEnabled} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-semibold text-slate-700">Spaced Repetition</span>
                                        <button onClick={() => setGlobalSrMode(!globalSrMode)} className={`w-10 h-5 rounded-full p-0.5 transition-colors ${globalSrMode ? 'bg-blue-600' : 'bg-slate-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow transform transition-transform ${globalSrMode ? 'translate-x-5' : ''}`}></div></button>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-2">
                                {loadingStats && <div className="text-center text-sm text-slate-400 p-2">Syncing stats...</div>}
                                {TOPICS[topic].subtopics.map((sub, idx) => {
                                    const data = topicStats[normalizeText(sub)] || { new: 0, due: 0 };
                                    const progressIndex = getProgress(sub);
                                    return (
                                        <button key={idx} onClick={() => onStartWorkout(sub, globalSrMode, timerEnabled ? timerValue : null)} className="w-full flex justify-between items-center p-4 bg-white border border-slate-100 rounded-lg hover:border-blue-300 hover:shadow-md transition-all text-left">
                                            <div>
                                                <span className="font-medium text-slate-700 block">{sub}</span>
                                                <div className="flex gap-2 mt-2">
                                                    {globalSrMode ? (
                                                        <>
                                                            {data.due > 0 && <span className="text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold">{data.due} Due</span>}
                                                            {data.new > 0 ? <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold">{data.new} New</span> : (data.due === 0 && <span className="text-[10px] text-slate-400 font-bold">All caught up</span>)}
                                                        </>
                                                    ) : (
                                                        <span className="text-[10px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full font-bold">Resuming at Q{progressIndex + 1}</span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {!globalSrMode && progressIndex > 0 && (
                                                    <div onClick={(e) => resetProgress(e, sub)} className="p-2 bg-slate-100 hover:bg-red-100 text-slate-400 hover:text-red-500 rounded-full transition-colors" title="Reset Progress"><Icon name="RotateCcw" size={14} /></div>
                                                )}
                                                <div className="bg-blue-50 text-blue-600 p-1.5 rounded-full"><Icon name="ChevronRight" size={16} /></div>
                                            </div>
                                        </button>
                                    )
                                })}
                            </div>
                        </div>
                    </div>
                );
            };

            const WorkoutView = ({ subtopic, questionsData, initialIndex, srMode, timerSetting, onBack, user }) => {
                const isCustomList = questionsData && questionsData.length > 0;
                const [questions, setQuestions] = useState(isCustomList ? questionsData : []);
                const [currentIdx, setCurrentIdx] = useState(initialIndex || 0);
                const [loading, setLoading] = useState(!isCustomList);
                const [timeLeft, setTimeLeft] = useState(timerSetting || 0);
                const [selectedOption, setSelectedOption] = useState(null); 
                const [isRevealed, setIsRevealed] = useState(false);

                const currentQ = questions[currentIdx];
                const getQText = (q) => q.question_text || q.q_text || "Error: Missing Text";
                const getOptions = (q) => q.options || [];

                useEffect(() => {
                    if (isCustomList) return;
                    const fetchQuestions = async () => {
                        setLoading(true);
                        let qData = [];
                        const { data: d1, error: e1 } = await supabase.from('questions').select('*').ilike('subtopic', subtopic);
                        if (!e1 && d1 && d1.length > 0) qData = d1;
                        else {
                            const { data: d2 } = await supabase.from('questions').select('*').ilike('topic', subtopic);
                            if (d2) qData = d2;
                        }
                        let finalQuestions = qData || [];
                        if (srMode) {
                            const qIds = finalQuestions.map(q => q.id);
                            const { data: pData } = await supabase.from('user_progress').select('*').eq('user_id', user.id).in('question_id', qIds);
                            
                            // FIX: ID String Matching
                            const progMap = {};
                            (pData||[]).forEach(p => progMap[String(p.question_id)] = p);

                            const now = new Date();
                            finalQuestions = finalQuestions.filter(q => {
                                const prog = progMap[String(q.id)];
                                return !prog || new Date(prog.next_review) <= now;
                            });
                            finalQuestions = finalQuestions.map(q => ({ ...q, progress: progMap[String(q.id)] }));
                            setQuestions(finalQuestions);
                        } else {
                            setQuestions(finalQuestions);
                            const key = `progress_${user.id}_${subtopic}`;
                            const savedIdx = parseInt(localStorage.getItem(key)) || 0;
                            if (savedIdx < finalQuestions.length) setCurrentIdx(savedIdx);
                            else { setCurrentIdx(0); localStorage.setItem(key, 0); }
                        }
                        setLoading(false);
                    };
                    fetchQuestions();
                }, [subtopic, srMode, user.id, isCustomList]);

                useEffect(() => {
                    if (!timerSetting || isRevealed || timeLeft <= 0) return;
                    const timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
                    return () => clearInterval(timer);
                }, [timeLeft, isRevealed, timerSetting]);

                const handleOptionClick = (index) => {
                    if (isRevealed) return;
                    setSelectedOption(index);
                    setIsRevealed(true);
                };

                const handlePrev = () => {
                    if(currentIdx > 0) {
                        const prevIdx = currentIdx - 1;
                        if (!srMode && !isCustomList) { 
                            const key = `progress_${user.id}_${subtopic}`; 
                            localStorage.setItem(key, prevIdx); 
                        }
                        setIsRevealed(false); setSelectedOption(null); setTimeLeft(timerSetting || 0); setCurrentIdx(prevIdx);
                    }
                };

                const handleNext = () => {
                    if (currentIdx < questions.length - 1) {
                        const nextIdx = currentIdx + 1;
                        if (!srMode && !isCustomList) { 
                            const key = `progress_${user.id}_${subtopic}`; 
                            localStorage.setItem(key, nextIdx); 
                        }
                        setIsRevealed(false); setSelectedOption(null); setTimeLeft(timerSetting || 0); setCurrentIdx(nextIdx);
                    } else {
                        if (!srMode && !isCustomList) { const key = `progress_${user.id}_${subtopic}`; localStorage.setItem(key, 0); }
                        alert("Workout Complete!"); onBack();
                    }
                };

                const handleReview = async (qualityScore) => {
                    if (isCustomList) { handleNext(); return; }
                    
                    const progress = currentQ.progress || { easiness_factor: 2.5, repetitions: 0, interval: 0 };
                    const prevEf = progress.easiness_factor || 2.5; 
                    
                    // Calculation with fixed Integers
                    const results = calculateSM2(qualityScore, prevEf, progress.repetitions, progress.interval);
                    
                    const nextDate = new Date();
                    nextDate.setTime(nextDate.getTime() + (results.interval * 24 * 60 * 60 * 1000));
                    
                    try {
                        // FIX: Ensure ID is standard
                        await supabase.from('user_progress').upsert({
                            user_id: user.id,
                            question_id: currentQ.id,
                            easiness_factor: results.ef,
                            repetitions: results.reps,
                            interval: results.interval,
                            next_review: nextDate.toISOString(),
                            last_reviewed: new Date().toISOString()
                        }, { onConflict: 'user_id, question_id' });
                    } catch(e) { console.error("Save failed", e); }
                    
                    if (qualityScore < 3) setQuestions(prev => [...prev, currentQ]);
                    handleNext();
                };

                if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-600 font-bold">Loading Questions...</div>;
                if (!currentQ) return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 text-center">
                        <div className="bg-white p-8 rounded-xl shadow-lg">
                            <Icon name="CheckCircle" size={48} className="text-green-500 mx-auto mb-4"/>
                            <h2 className="text-xl font-bold text-slate-800">All caught up!</h2>
                            <p className="text-slate-500 mb-6">{srMode ? "No questions due for review." : "No questions found in this topic."}</p>
                            <button onClick={onBack} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Go Back</button>
                        </div>
                    </div>
                );

                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center pb-20">
                        <div className="w-full bg-white shadow-sm p-4 sticky top-0 z-20 flex justify-between items-center">
                            <button onClick={onBack} className="text-slate-500 hover:text-blue-600"><Icon name="XCircle" size={24} /></button>
                            <div className="text-sm font-bold text-slate-700 truncate max-w-[200px]">{isCustomList ? "Search Results" : subtopic}</div>
                            <div className={`font-mono font-bold text-lg ${timeLeft < 10 && timeLeft > 0 ? 'text-red-500' : 'text-blue-600'}`}>{timerSetting ? timeLeft + 's' : ''}</div>
                        </div>
                        <div className="w-full max-w-2xl p-4 flex-grow flex flex-col">
                            <div className="bg-white rounded-2xl shadow-sm p-6 mb-6">
                                <div className="flex justify-between items-center mb-2">
                                    <div className="text-xs font-bold text-blue-500 uppercase tracking-wide">Question {currentIdx + 1} / {questions.length}</div>
                                </div>
                                <p className="text-lg text-slate-800 leading-relaxed font-medium">{getQText(currentQ)}</p>
                            </div>
                            <div className="mb-6 space-y-3">
                                {getOptions(currentQ).map((opt, idx) => {
                                    let style = "w-full p-4 rounded-xl border-2 text-left transition-all mb-3 flex justify-between items-center bg-white ";
                                    if (isRevealed) {
                                        if (idx === currentQ.correct_index) style += "border-green-500 bg-green-50 text-green-700 font-medium";
                                        else if (idx === selectedOption) style += "border-red-500 bg-red-50 text-red-700";
                                        else style += "border-slate-100 opacity-60";
                                    } else {
                                        style += "border-slate-100 hover:border-blue-300 text-slate-700";
                                    }
                                    return (
                                        <button key={idx} onClick={() => handleOptionClick(idx)} className={style} disabled={isRevealed && srMode}>
                                            <span>{opt}</span>
                                            {isRevealed && idx === currentQ.correct_index && <Icon name="CheckCircle" className="text-green-500" size={20}/>}
                                            {isRevealed && idx === selectedOption && idx !== currentQ.correct_index && <Icon name="XCircle" className="text-red-500" size={20}/>}
                                        </button>
                                    );
                                })}
                            </div>
                            {isRevealed && (
                                <div className="slide-in mb-6">
                                    <div className="bg-blue-50 border border-blue-100 rounded-xl p-5">
                                        <h4 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icon name="BookOpen" size={18}/> Explanation</h4>
                                        <p className="text-slate-700 text-sm leading-relaxed">{currentQ.explanation}</p>
                                    </div>
                                </div>
                            )}
                            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 shadow-lg">
                                <div className="max-w-2xl mx-auto">
                                    {srMode && !isCustomList ? (
                                        isRevealed && (
                                            <div className="grid grid-cols-4 gap-3">
                                                <button onClick={() => handleReview(0)} className="flex flex-col items-center py-2 bg-red-50 text-red-600 rounded-lg"><span className="text-xs font-bold">Again</span><span className="text-[10px]">&lt; 1m</span></button>
                                                <button onClick={() => handleReview(3)} className="flex flex-col items-center py-2 bg-orange-50 text-orange-600 rounded-lg"><span className="text-xs font-bold">Hard</span><span className="text-[10px]">12h</span></button>
                                                <button onClick={() => handleReview(4)} className="flex flex-col items-center py-2 bg-blue-50 text-blue-600 rounded-lg"><span className="text-xs font-bold">Good</span><span className="text-[10px]">1d</span></button>
                                                <button onClick={() => handleReview(5)} className="flex flex-col items-center py-2 bg-green-50 text-green-600 rounded-lg"><span className="text-xs font-bold">Easy</span><span className="text-[10px]">4d</span></button>
                                            </div>
                                        )
                                    ) : (
                                        <div className="flex justify-between w-full">
                                            <button onClick={handlePrev} disabled={currentIdx === 0} className={`flex items-center gap-1 font-bold px-6 py-2 rounded-lg transition-colors ${currentIdx === 0 ? 'text-slate-300 cursor-not-allowed' : 'text-blue-600 hover:bg-blue-50'}`}><Icon name="ChevronLeft" size={20} /> Prev</button>
                                            <button onClick={handleNext} className="flex items-center gap-1 bg-blue-600 text-white font-bold px-8 py-2 rounded-lg hover:bg-blue-700 shadow-md">Next <Icon name="ChevronRight" size={20} /></button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const App = () => {
                const [view, setView] = useState('login');
                const [user, setUser] = useState(null);
                const [activeTopic, setActiveTopic] = useState(null);
                const [workoutConfig, setWorkoutConfig] = useState({});
                const [appSrMode, setAppSrMode] = useState(true); 

                // --- APP REHYDRATION LOGIC START ---
                useEffect(() => {
                    const savedUser = localStorage.getItem('ssc_user');
                    if (savedUser) { 
                        try { 
                            const u = JSON.parse(savedUser); 
                            if(u && u.id) { 
                                setUser(u); 
                                const savedNav = localStorage.getItem('ssc_nav_state');
                                if (savedNav) {
                                    const nav = JSON.parse(savedNav);
                                    if (nav.view) setView(nav.view);
                                    if (nav.activeTopic) setActiveTopic(nav.activeTopic);
                                    if (nav.workoutConfig) setWorkoutConfig(nav.workoutConfig);
                                    if (nav.appSrMode !== undefined) setAppSrMode(nav.appSrMode);
                                } else {
                                    setView('home'); 
                                }
                            } 
                        } catch(e){
                            console.error("Session restoration failed:", e);
                            localStorage.removeItem('ssc_user');
                        } 
                    }
                }, []);
                
                // --- STATE PERSISTENCE LOGIC START ---
                useEffect(() => {
                    if (user) {
                        try {
                            const navState = { view, activeTopic, workoutConfig, appSrMode };
                            if (workoutConfig?.questionsData?.length > 100) {
                            }
                            localStorage.setItem('ssc_nav_state', JSON.stringify(navState));
                        } catch (e) { console.error("Could not save nav state", e); }
                    }
                }, [view, activeTopic, workoutConfig, appSrMode, user]);

                const handleLogin = (u) => { 
                    localStorage.setItem('ssc_user', JSON.stringify(u)); 
                    setUser(u); 
                    setView('home'); 
                };
                
                const handleLogout = () => { 
                    localStorage.removeItem('ssc_user'); 
                    localStorage.removeItem('ssc_nav_state'); 
                    window.location.reload(); 
                };
                
                const handleTopicSelect = (topic) => { setActiveTopic(topic); setView('subtopic'); };
                
                const handleStartWorkout = (subtopic, srModeOverride, timerVal) => { 
                    setWorkoutConfig({ subtopic, srMode: srModeOverride, timerSetting: timerVal, questionsData: null, initialIndex: 0 }); 
                    setView('workout'); 
                };

                return (
                    <div>
                        {view === 'login' && <Auth onLogin={handleLogin} />}
                        {view === 'home' && <Home user={user} onSelectTopic={handleTopicSelect} onLogout={handleLogout} globalSrMode={appSrMode} setGlobalSrMode={setAppSrMode} />}
                        {view === 'subtopic' && <SubtopicView topic={activeTopic} globalSrMode={appSrMode} setGlobalSrMode={setAppSrMode} onBack={() => setView('home')} onStartWorkout={handleStartWorkout} user={user} />}
                        {view === 'workout' && <WorkoutView {...workoutConfig} onBack={() => setView('subtopic')} user={user} />}
                    </div>
                );
            };
            const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
        } catch (err) {
            console.error(err);
        }
    </script>
</body>
</html>