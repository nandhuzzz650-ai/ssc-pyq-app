<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Daily Intellect SSC PYQ</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif;background-color:#f3f4f6}.red-brand{background-color:#D32F2F}.option-btn{transition:all .2s;border:2px solid #e5e7eb;background:#fff}.correct{background-color:#def7ec!important;border-color:#31c48d!important;color:#03543f!important}.wrong{background-color:#fde8e8!important;border-color:#f05252!important;color:#9b1c1c!important}.switch{position:relative;display:inline-block;width:40px;height:20px}.switch input{opacity:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.slider{background-color:#4ade80}input:checked+.slider:before{transform:translateX(20px)}.animate-pop{animation:pop .3s cubic-bezier(.175,.885,.32,1.275)}@keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}#offline-indicator{display:none}body.is-offline #offline-indicator{display:flex}
#timer-display{font-variant-numeric: tabular-nums;}
.timer-warn{color: #D32F2F; animation: pulse 1s infinite;}
@keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}

/* New Streak Animation Styles */
@keyframes streak-glow {
    0% { transform: scale(1); filter: drop-shadow(0 0 0px #f97316); }
    50% { transform: scale(1.3); filter: drop-shadow(0 0 15px #f97316); }
    100% { transform: scale(1); filter: drop-shadow(0 0 0px #f97316); }
}
.streak-active { animation: streak-glow 0.8s ease-in-out 3; }

#finish-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(255,255,255,0.95);
    z-index: 1000;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.checkmark-circle {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 2;
    stroke: #31c48d;
    stroke-miterlimit: 10;
    box-shadow: inset 0px 0px 0px #31c48d;
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
}
.checkmark-check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
}
@keyframes stroke { 100% { stroke-dashoffset: 0; } }
@keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
@keyframes fill { 100% { box-shadow: inset 0px 0px 0px 40px #31c48d; } }
#timer-master-toggle + .slider { background-color: #f05252; }
#timer-master-toggle:checked + .slider { background-color: #31c48d; }
.explanation-box {
    margin-top: 1rem;
    padding: 1rem;
    background-color: #f9fafb;
    border: 2px solid #111827;
    border-radius: 0.75rem;
    font-size: 0.75rem;
    color: #1f2937;
    line-height: 1.4;
    animation: pop 0.3s cubic-bezier(.175,.885,.32,1.275);
}
</style>
</head>
<body class="pb-12">
<div id="finish-overlay">
    <svg class="checkmark-circle" viewBox="0 0 52 52">
        <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <h3 class="text-2xl font-black mt-4 text-gray-800 uppercase tracking-tighter">Topic Finished!</h3>
    <p class="text-xs font-bold text-gray-400 mt-1 uppercase">Your progress has been saved</p>
</div>
<div id="offline-indicator" class="fixed top-0 left-0 w-full bg-orange-600 text-white text-[10px] font-bold uppercase p-1 justify-center items-center z-[1000]">Offline - Progress will sync later</div>

<div id="login-screen" class="fixed inset-0 bg-white z-[200] flex items-center justify-center p-6 overflow-y-auto">
<div class="max-w-sm w-full text-center">
<h1 class="text-4xl font-black mb-2 text-red-700 uppercase">Daily Intellect</h1>
<p class="text-gray-400 mb-8 font-bold text-[10px] tracking-widest uppercase">Personalized Learning System</p>
<div id="auth-box" class="space-y-2">
<input type="text" id="username-input" class="w-full border-2 p-4 rounded-2xl text-center text-xl font-bold focus:border-red-500 outline-none" placeholder="Username">
<input type="password" id="password-input" class="w-full border-2 p-4 rounded-2xl text-center text-xl font-bold focus:border-red-500 outline-none" placeholder="Password">
<div id="reg-fields" class="hidden space-y-2 pt-2 text-left">
<input type="text" id="recovery-q" class="w-full p-4 border-2 rounded-2xl text-sm" placeholder="Security Question">
<input type="text" id="recovery-a" class="w-full p-4 border-2 rounded-2xl text-sm" placeholder="Your Answer">
</div>
<div class="pt-4 space-y-3">
<button id="signin-btn" onclick="handleSignIn()" class="w-full red-brand text-white py-4 rounded-2xl font-bold shadow-lg uppercase tracking-widest">Sign In</button>
<button id="signup-toggle" onclick="toggleSignupMode(true)" class="w-full bg-gray-100 text-gray-600 py-4 rounded-2xl font-bold uppercase text-xs">Create Account</button>
<button id="signup-confirm" onclick="handleSignUp()" class="hidden w-full bg-black text-white py-4 rounded-2xl font-bold uppercase">Complete Sign Up</button>
<button id="back-to-login" onclick="toggleSignupMode(false)" class="hidden mt-2 text-xs text-gray-400 font-bold uppercase">Back to Login</button>
</div>
</div>
</div>
</div>

<nav class="red-brand text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
<div><h1 class="text-[10px] font-black uppercase tracking-widest opacity-80 leading-none">Daily Intellect</h1><h2 class="text-lg font-black uppercase tracking-tighter">SSC PYQs</h2><p class="text-[9px] opacity-70 uppercase font-bold">User: <span id="display-user"></span></p></div>
<div class="flex items-center gap-2">
<button onclick="ss('leaderboard-screen');showLB()" class="bg-black/20 px-3 py-1.5 rounded-full text-[9px] font-black uppercase">üèÜ Ranks</button>
<button onclick="handleLogout()" class="bg-black/20 p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
<div id="nav-srs-container" class="bg-black/20 px-3 py-1.5 rounded-full flex items-center gap-2">
    <span class="text-[9px] font-black uppercase tracking-tighter">Spaced Repetition</span>
    <label class="switch"><input type="checkbox" id="nav-srs-toggle" checked onchange="handleSRSToggle(this.checked)"><span class="slider"></span></label>
</div>
</div>
</nav>

<main class="max-w-5xl mx-auto p-4">
<section id="home-screen" class="hidden">
<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-black text-gray-800 uppercase">Topics</h2><div class="bg-orange-50 px-3 py-1 rounded-xl border border-orange-100 font-black text-orange-600 text-sm transition-all" id="home-streak-display">0 üî•</div></div>
<div id="subject-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
</section>

<section id="topic-screen" class="hidden">
<div class="flex justify-between items-start mb-6"><div><h1 class="text-2xl font-black text-red-700 uppercase">Daily Intellect</h1><p class="text-[8px] tracking-widest uppercase">Personalized System</p></div><div class="bg-orange-50 px-4 py-2 rounded-2xl border border-orange-100 text-center" id="topic-streak-box"><p class="text-[10px] font-black text-orange-400 uppercase leading-none">Streak</p><p class="text-xl font-black text-orange-600 leading-tight mt-1"><span id="topic-streak-count">0</span> üî•</p></div></div>
<div class="flex flex-wrap justify-between items-center mb-6 gap-4">
    <button onclick="handleHardwareBack()" class="text-red-600 font-bold text-xs uppercase flex items-center gap-1">‚Üê Back</button>
<div class="flex items-center gap-4 bg-white px-3 py-2 rounded-xl border shadow-sm">
    <div class="flex items-center gap-2">
        <span class="text-[10px] font-black uppercase text-gray-400">‚è±Ô∏è Timer</span>
        <label class="switch">
            <input type="checkbox" id="timer-master-toggle" checked onchange="saveTimerPref()">
            <span class="slider"></span>
        </label>
    </div>
    <div class="flex items-center gap-2 border-l pl-3">
        <span id="timer-label" class="text-xs font-bold text-red-700 w-8 text-center">0s</span>
        <input type="range" id="timer-range" oninput="updateTimerLabel(this.value)" class="w-20 accent-red-600">
    </div>
</div>
</div>

<div id="search-container" class="mb-6">
    <div class="relative">
        <input type="text" id="topic-search-input" oninput="filterTopics()" placeholder="Search in questions & options..." class="w-full bg-white border-2 border-gray-100 p-3 rounded-xl text-sm font-bold focus:border-red-500 outline-none pr-10">
        <div class="absolute right-3 top-3 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        </div>
    </div>
</div>

<h2 id="current-subject-title" class="text-3xl font-black mb-8 text-gray-800 leading-tight"></h2>
<div id="topic-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
</section>

<section id="quiz-screen" class="hidden">
<div class="max-w-2xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <button onclick="handleHardwareBack()" class="flex items-center gap-1 text-red-600 font-bold text-xs uppercase"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg> Exit</button>
        <div id="timer-box" class="flex flex-col items-center">
            <span id="timer-display" class="text-2xl font-black text-gray-800 tabular-nums">00</span>
            <span class="text-[8px] font-black uppercase text-gray-400 tracking-widest">Seconds Left</span>
        </div>
        <div id="progress-text" class="bg-gray-100 px-3 py-1 rounded-full text-[10px] font-black text-gray-500 uppercase"></div>
    </div>
<div class="bg-white p-6 md:p-10 rounded-3xl shadow-xl border border-gray-50"><h3 id="question-text" class="text-xl font-bold mb-8 text-gray-800"></h3><div id="options-grid" class="space-y-3"></div>

<div id="non-srs-nav" class="hidden mt-8 flex justify-between gap-4">
    <button onclick="navPrev()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold uppercase text-xs">Previous</button>
    <button onclick="navNext()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Next</button>
</div>

<div id="srs-actions" class="hidden mt-8">
    <div id="srs-rating-buttons" class="grid grid-cols-3 gap-2 text-center">
        <button onclick="submitReview(2)" class="bg-gray-100 p-3 rounded-xl"><span class="block font-black text-[10px] uppercase text-gray-500">Hard</span><span id="time-hard" class="text-[9px] text-gray-400">Loop</span></button>
        <button onclick="submitReview(4)" class="bg-blue-50 p-3 rounded-xl border border-blue-100"><span class="block font-black text-[10px] text-blue-500 uppercase">Good</span><span id="time-good" class="text-[9px] text-blue-400"></span></button>
        <button onclick="submitReview(5)" class="bg-green-50 p-3 rounded-xl border border-green-100"><span class="block font-black text-[10px] text-green-500 uppercase">Easy</span><span id="time-easy" class="text-[9px] text-green-400"></span></button>
    </div>
    <div id="srs-next-container" class="hidden">
        <button onclick="submitReview(4)" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold uppercase text-sm shadow-lg">Next Question</button>
    </div>
</div>
</div>
</div>
</section>

<section id="leaderboard-screen" class="hidden"><button onclick="handleHardwareBack()" class="mb-6 text-red-600 font-bold text-xs uppercase">‚Üê Back</button><h2 class="text-3xl font-black mb-6 text-gray-800 uppercase">Global Rankings</h2><div id="leaderboard-list" class="space-y-3"></div></section>
</main>

<script>
const SU='https://lkwciklwwssrwzgecrvv.supabase.co',SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxrd2Npa2x3d3Nzcnd6Z2VjcnZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5NjAwNjYsImV4cCI6MjA4NDUzNjA2Nn0.l-M24USVWXR_WOJLP0vP3MtXfCsllU9n1VXOau9JN8A',_s=supabase.createClient(SU,SK);
let cur=localStorage.getItem('dailyIntellectUser')||"",master=[],topicQs=[],idx=0;
let timerInterval, timeLeft, currentSubject;
let isSearchActive = false;

const syl={
    "Quantitative Aptitude":["Computation of whole numbers","Decimals","Fractions","Relationships between numbers","Profit and Loss","Discount","Partnership Business","Mixture and Alligation","Time and distance","Time & Work","Percentage","Ratio & Proportion","Square roots","Averages","Interest","Basic algebraic identities","Graphs of Linear Equations","Triangle and various kinds of centres","Congruence and similarity of triangles","Circle and its chords, tangents, etc.","Triangle","Quadrilaterals","Regular Polygons","Right Prism","Right Circular Cone","Right Circular Cylinder","Sphere","Heights and Distances","Histogram","Frequency polygon","Bar diagram & Pie chart","Hemispheres","Rectangular Parallelepiped","Regular Right Pyramid","Trigonometric ratio","Degree and Radian Measures","Standard Identities","Complementary angles"],
    "General Intelligence and Reasoning":["Analogies","Similarities and differences","Space visualization","Spatial orientation","Problem-solving","Analysis","Judgment","Blood Relations","Decision making","Visual memory","Discrimination","Observation","Relationship concepts","Arithmetical reasoning","Figural classification","Arithmetic number series","Non-verbal series","Coding and decoding","Statement conclusion","Syllogistic reasoning"],
    "English Comprehension":["Idioms and Phrases","One word Substitution","Sentence Correction","Error Spotting","Fill in the Blanks","Spellings Correction","Reading Comprehension","Synonyms-Antonyms","Active Passive","Sentence Rearrangement","Sentence Improvement","Cloze test"],
    "General Awareness":["History","Culture","Geography","Economic Scene","General Policy","Scientific Research","Science","Current Affairs","Books and Authors","Sports","Important Schemes","Important Days","Portfolio","People in News","Static GK"]
};

const timerRanges = {
    "Quantitative Aptitude": {min: 40, max: 60},
    "General Intelligence and Reasoning": {min: 20, max: 30},
    "English Comprehension": {min: 20, max: 30},
    "General Awareness": {min: 10, max: 20}
};

if('serviceWorker' in navigator){
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW Registered'))
        .catch(err => console.log('SW Registration failed'));
    });
}

window.addEventListener('online',()=>{document.body.classList.remove('is-offline');syncOffline()});
window.addEventListener('offline',()=>document.body.classList.add('is-offline'));

window.onload=async function(){
    if(cur){
        await app();
        const lastHash=window.location.hash.replace('#','');
        const lastSub=sessionStorage.getItem('lastSub');
        const lastTopic=sessionStorage.getItem('lastTopic');
        
        if(lastHash==='quiz-screen'&&lastTopic){
            const qs=master.filter(q=>q.topic===lastTopic);
            if(qs.length>0) startPractice(qs, true); 
            else ss('home-screen');
        }else if(lastHash==='topic-screen'&&lastSub){
            openSubject(lastSub);ss('topic-screen');
        }else if(lastHash&&lastHash!=='login-screen'){
            rs(lastHash);
        }else{
            ss('home-screen');
        }
    }
};

window.onpopstate=function(e){if(e.state&&e.state.sid)rs(e.state.sid);else rs('home-screen')};
function ss(id){window.history.pushState({sid:id},"",`#${id}`);rs(id)}

function rs(id){
    clearInterval(timerInterval); 
    ['login-screen','home-screen','topic-screen','quiz-screen','leaderboard-screen'].forEach(s=>{const el=document.getElementById(s);if(el)el.classList.add('hidden')});
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');
    
    const srsBtn = document.getElementById('nav-srs-container');
    if(srsBtn) {
        if(id === 'home-screen' || id === 'topic-screen') srsBtn.classList.remove('hidden');
        else srsBtn.classList.add('hidden');
    }
}

function handleHardwareBack(){
    window.history.back();
    setTimeout(fetchData,100);
}

function handleLogout(){localStorage.clear();sessionStorage.clear();window.location.hash="";location.reload()}

async function handleSignIn(){const u=document.getElementById('username-input').value.trim().toLowerCase(),p=document.getElementById('password-input').value.trim();if(!u||!p)return alert("Fill all fields");const b=document.getElementById('signin-btn');b.innerText="Connecting...";try{const{data,error}=await _s.from('users').select('*').eq('username',u).maybeSingle();if(data&&data.password===p){cur=u;localStorage.setItem('dailyIntellectUser',u);await app();ss('home-screen')}else alert("Invalid Login")}catch(e){alert(e.message)}finally{b.innerText="Sign In"}}
async function handleSignUp(){const u=document.getElementById('username-input').value.trim().toLowerCase(),p=document.getElementById('password-input').value.trim(),q=document.getElementById('recovery-q').value.trim(),a=document.getElementById('recovery-a').value.trim().toLowerCase();const{error}=await _s.from('users').insert([{username:u,password:p,recovery_question:q,recovery_answer:a}]);if(error)return alert("Taken");cur=u;localStorage.setItem('dailyIntellectUser',u);await app();ss('home-screen')}

async function app(){
    document.getElementById('display-user').innerText=cur;
    document.getElementById('login-screen').classList.add('hidden');
    loadLocalData();
    renderHome();
    
    const oldStreak = parseInt(localStorage.getItem(`s_${cur}`)) || 0;
    upUI(oldStreak);
    
    if(navigator.onLine) {
        try { 
            await syncOffline(); 
            await _s.rpc('update_user_streak',{p_username:cur});
            const{data}=await _s.from('users').select('streak_count').eq('username',cur).maybeSingle();
            
            if(data){
                const newStreak = data.streak_count;
                localStorage.setItem(`s_${cur}`, newStreak);
                upUI(newStreak);
                
                // Trigger Animation if streak increased
                if(newStreak > oldStreak) {
                    triggerStreakAnimation();
                }
            }
            await fetchData(); 
        } catch(e) { console.log('Background sync skipped'); }
    }
}

function triggerStreakAnimation() {
    const displays = [document.getElementById('home-streak-display'), document.getElementById('topic-streak-box')];
    displays.forEach(el => {
        if(el) {
            el.classList.add('streak-active');
            setTimeout(() => el.classList.remove('streak-active'), 2500);
        }
    });
}

function upUI(s){
    document.getElementById('topic-streak-count').innerText=s;
    document.getElementById('home-streak-display').innerText=`${s} üî•`;
}

function handleSRSToggle(checked) {
    localStorage.setItem('srs_enabled', checked);
    fetchData();
}

async function fetchData(){
    if(navigator.onLine){
        const isS = localStorage.getItem('srs_enabled') !== 'false';
        document.getElementById('nav-srs-toggle').checked = isS;
        try {
            let res=isS?await _s.rpc('get_due_questions',{user_name:cur}):await _s.from('questions').select('*');
            if(res.data) {
                master=res.data;
                localStorage.setItem('c_q',JSON.stringify(master));
                renderHome(); 
                if(document.getElementById('topic-screen').classList.contains('hidden') === false) {
                    openSubject(currentSubject);
                }
            }
        } catch(e) { console.log('Database unreachable'); }
    }
}

function loadLocalData(){
    const c=localStorage.getItem('c_q');
    if(c) master=JSON.parse(c);
    const isS = localStorage.getItem('srs_enabled') !== 'false';
    document.getElementById('nav-srs-toggle').checked = isS;
}

function renderHome(){const g=document.getElementById('subject-grid');g.innerHTML="";Object.keys(syl).forEach(s=>{const c=master.filter(q=>syl[s].includes(q.topic)).length;g.innerHTML+=`<div onclick="ss('topic-screen');openSubject('${s}')" class="bg-white p-6 rounded-2xl border-2 border-gray-100 cursor-pointer shadow-lg hover:border-red-500 transition"><h3 class="font-black">${s}</h3><p class="text-[10px] text-gray-400 font-bold uppercase mt-1 tracking-widest leading-none">${c} Due</p></div>`})}

function saveTimerPref() {
    const isEnabled = document.getElementById('timer-master-toggle').checked;
    localStorage.setItem('timer_enabled', isEnabled);
}

function updateTimerLabel(val) {
    document.getElementById('timer-label').innerText = val + 's';
    localStorage.setItem(`t_${currentSubject}`, val);
}

function openSubject(s){
    currentSubject = s;
    sessionStorage.setItem('lastSub',s);
    document.getElementById('current-subject-title').innerText=s;
    document.getElementById('topic-search-input').value = ""; 
    const range = timerRanges[s] || {min: 10, max: 30};
    const slider = document.getElementById('timer-range');
    slider.min = range.min;
    slider.max = range.max;
    const saved = localStorage.getItem(`t_${s}`) || range.min;
    slider.value = saved;
    updateTimerLabel(saved);
    renderTopics();
}

function renderTopics(searchResults = null) {
    const l=document.getElementById('topic-list');
    const isSrsEnabled = localStorage.getItem('srs_enabled') !== 'false';
    l.innerHTML="";
    
    if (searchResults) {
        searchResults.forEach(q => {
            l.innerHTML += `
                <div onclick="startPractice([${JSON.stringify(q).replace(/"/g, '&quot;')}], false)" class="bg-white p-4 rounded-xl border-2 border-blue-100 shadow-sm cursor-pointer hover:bg-blue-50">
                    <p class="text-xs font-bold text-gray-800 line-clamp-2">${q.q_text || q.q}</p>
                    <p class="text-[8px] text-blue-500 font-black uppercase mt-1 tracking-widest">${q.topic}</p>
                </div>`;
        });
        return;
    }

    const processTopic = (t, count, isFromSearch = false) => {
        const savedIdx = localStorage.getItem(`lastIdx_${cur}_${t}`);
        const hasProgress = !isSrsEnabled && !isFromSearch && savedIdx !== null && parseInt(savedIdx) > 0;
        
        return `
            <div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm cursor-pointer hover:bg-red-50 group">
                <div onclick="startPractice(null, false, '${t}')" class="flex-1">
                    <span class="font-bold text-gray-700">${t}</span>
                    ${hasProgress ? `<p class="text-[9px] text-orange-500 font-bold uppercase">Resuming at Q${parseInt(savedIdx)+1}</p>` : ''}
                </div>
                <div class="flex items-center gap-2">
                    ${hasProgress ? `<button onclick="resetTopicProgress('${t}')" class="p-2 hover:bg-red-100 rounded-lg text-red-500 transition-colors" title="Reset Progress">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>` : ''}
                    <span class="text-xs font-black bg-red-100 text-red-700 px-2 py-1 rounded">${count}</span>
                </div>
            </div>`;
    };

    syl[currentSubject].forEach(t => {
        const c = master.filter(q => q.topic === t).length;
        l.innerHTML += processTopic(t, c, false);
    });
}

function resetTopicProgress(topicName) {
    if(confirm(`Reset progress for "${topicName}"?`)) {
        localStorage.removeItem(`lastIdx_${cur}_topicName`);
        renderTopics();
    }
}

function filterTopics() {
    const query = document.getElementById('topic-search-input').value.toLowerCase().trim();
    
    if(!query) {
        isSearchActive = false;
        return renderTopics();
    }

    const matchingQs = master.filter(q => {
        const inQuestion = (q.q_text || q.q || "").toLowerCase().includes(query);
        const inOptions = q.options && q.options.some(opt => opt.toLowerCase().includes(query));
        return inQuestion || inOptions;
    });
    
    isSearchActive = true;
    renderTopics(matchingQs);
}

function startPractice(qs, isResuming = false, topicName = null){
    const isSrsEnabled = localStorage.getItem('srs_enabled') !== 'false';

    if (topicName) {
        isSearchActive = false;
        topicQs = master.filter(q => q.topic === topicName);
    } else if (qs) {
        topicQs = [...qs];
        if (!isResuming) isSearchActive = true;
    }
    
    if(!topicQs || topicQs.length===0) return isResuming ? null : alert("No questions!");

    if (!isSrsEnabled) {
        const savedIdx = localStorage.getItem(`lastIdx_${cur}_${topicQs[0].topic}`);
        idx = (savedIdx !== null && !isSearchActive && parseInt(savedIdx) < topicQs.length) ? parseInt(savedIdx) : 0;
    } else {
        if (!isResuming) {
            if (!isSearchActive) {
                for(let i=topicQs.length-1;i>0;i--){
                    const j=Math.floor(Math.random()*(i+1));
                    [topicQs[i],topicQs[j]]=[topicQs[j],topicQs[i]];
                }
            }
            idx = 0;
        }
    }

    sessionStorage.setItem('lastTopic', topicQs[0].topic);
    ss('quiz-screen');
    loadQ();
}

function startTimer() {
    clearInterval(timerInterval);
    const setTime = parseInt(localStorage.getItem(`t_${currentSubject}`)) || 15;
    timeLeft = setTime;
    const display = document.getElementById('timer-display');
    display.classList.remove('timer-warn');
    display.innerText = timeLeft;
    timerInterval = setInterval(() => {
        timeLeft--;
        display.innerText = timeLeft < 10 ? "0" + timeLeft : timeLeft;
        if(timeLeft <= 5) display.classList.add('timer-warn');
        if(timeLeft <= 0) {
            clearInterval(timerInterval);
            handleTimeUp();
        }
    }, 1000);
}

function handleTimeUp() {
    const q = topicQs[idx];
    const isSrs = localStorage.getItem('srs_enabled') !== 'false';
    const b = document.querySelectorAll('.option-btn');
    b.forEach(btn => btn.disabled = true);
    b[q.correct].classList.add('correct');
    showExplanation();
    if(isSrs) toggleSRSActions(true);
}

async function loadQ(){
    const q=topicQs[idx];
    const isSrs = localStorage.getItem('srs_enabled') !== 'false';
    
    if (!isSrs && !isSearchActive) {
        localStorage.setItem(`lastIdx_${cur}_${q.topic}`, idx);
    }
    
    document.getElementById('progress-text').innerText=`${idx+1}/${topicQs.length}`;
    document.getElementById('question-text').innerText=q.q_text||q.q;
    document.getElementById('srs-actions').classList.add('hidden');
    document.getElementById('non-srs-nav').classList.toggle('hidden', isSrs);
    const g=document.getElementById('options-grid');
    g.innerHTML="";
    q.options.forEach((o,i)=>{g.innerHTML+=`<button onclick="checkAns(${i},${q.correct})" class="option-btn w-full p-4 rounded-xl text-left font-bold text-sm shadow-sm text-gray-800">${o}</button>`});
    const tBox = document.getElementById('timer-box');
    const timerOn = (localStorage.getItem('timer_enabled') !== 'false'); 
    if (timerOn) {
        tBox.style.display = 'flex';
        startTimer();
    } else {
        tBox.style.display = 'none';
        clearInterval(timerInterval);
    }
    if(isSrs && !isSearchActive) await labels(q.id);
}

function navPrev() { if(idx > 0) { idx--; loadQ(); } }

function navNext() { 
    if(idx < topicQs.length - 1) { 
        idx++; 
        loadQ(); 
    } else { 
        sessionStorage.removeItem('lastTopic');
        const overlay = document.getElementById('finish-overlay');
        overlay.style.display = 'flex'; 
        setTimeout(() => {
            overlay.style.display = 'none'; 
            handleHardwareBack(); 
        }, 1500);
    } 
}

async function labels(id){const cK=`l_${cur}_${id}`;if(!navigator.onLine){const c=localStorage.getItem(cK);if(c){const d=JSON.parse(c);document.getElementById('time-good').innerText=d.g+"d";document.getElementById('time-easy').innerText=d.e+"d";return}}try{const{data:u}=await _s.from('user_progress').select('*').eq('username',cur).eq('question_id',id).maybeSingle();const ef=u?.ease_factor||2.5,iv=u?.interval||0,reps=u?.repetitions||0,g=reps===0?1:(reps===1?4:Math.round(iv*ef)),e=Math.round((iv||1)*(ef+0.15)*1.3);document.getElementById('time-good').innerText=g+"d";document.getElementById('time-easy').innerText=e+"d";localStorage.setItem(cK,JSON.stringify({g,e}))}catch(e){}}

function checkAns(i,c){
    clearInterval(timerInterval); 
    const isSrs = localStorage.getItem('srs_enabled') !== 'false';
    const b=document.querySelectorAll('.option-btn');
    b.forEach(btn=>btn.disabled=true);
    if(i===c)b[i].classList.add('correct');
    else{b[i].classList.add('wrong');b[c].classList.add('correct')}
    showExplanation();
    if(isSrs) toggleSRSActions(true);
}

function toggleSRSActions(show) {
    const srsActions = document.getElementById('srs-actions');
    const ratingBtns = document.getElementById('srs-rating-buttons');
    const nextContainer = document.getElementById('srs-next-container');

    if (show) {
        srsActions.classList.remove('hidden');
        if (isSearchActive) {
            ratingBtns.classList.add('hidden');
            nextContainer.classList.remove('hidden');
        } else {
            ratingBtns.classList.remove('hidden');
            nextContainer.classList.add('hidden');
        }
    } else {
        srsActions.classList.add('hidden');
    }
}

function showExplanation() {
    const q = topicQs[idx];
    if (q.explanation) {
        const g = document.getElementById('options-grid');
        const eDiv = document.createElement('div');
        eDiv.className = "explanation-box";
        eDiv.innerHTML = `<div class="font-black uppercase text-[9px] mb-1 text-gray-400 tracking-widest">Explanation</div>${q.explanation}`;
        g.appendChild(eDiv);
    }
}

async function submitReview(qV){
    clearInterval(timerInterval); 
    const cQ=topicQs[idx];

    if (!isSearchActive) {
        const d={p_username:cur, p_question_id:cQ.id, p_quality:qV};
        if(navigator.onLine) await _s.rpc('handle_user_answer',d);
        else {
            const qe=JSON.parse(localStorage.getItem('q')||"[]");
            qe.push(d);
            localStorage.setItem('q',JSON.stringify(qe));
        }
        if(qV>2){
            master=master.filter(i=>i.id!==cQ.id);
            localStorage.setItem('c_q',JSON.stringify(master));
        }
    }

    if(idx < topicQs.length - 1){
        idx++;
        loadQ();
    } else {
        sessionStorage.removeItem('lastTopic');
        if (!isSearchActive) {
            localStorage.removeItem(`lastIdx_${cur}_${cQ.topic}`);
        }
        const overlay = document.getElementById('finish-overlay');
        overlay.style.display = 'flex'; 
        setTimeout(() => {
            overlay.style.display = 'none'; 
            handleHardwareBack(); 
        }, 1500);
    }
}
async function syncOffline(){const qe=JSON.parse(localStorage.getItem('q')||"[]");if(qe.length){for(let d of qe)await _s.rpc('handle_user_answer',d);await _s.rpc('update_user_streak',{p_username:cur});localStorage.removeItem('q');await fetchData()}}
async function showLB(){const l=document.getElementById('leaderboard-list');l.innerHTML="Loading...";if(!navigator.onLine)return l.innerHTML="Online only";const{data}=await _s.from('leaderboard').select('*');l.innerHTML="";data.forEach((e,i)=>{const m=i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":`#${i+1}`;l.innerHTML+=`<div class="flex justify-between items-center p-4 bg-white rounded-2xl border-2 shadow-sm ${e.username===cur?'border-orange-500 bg-orange-50':'border-gray-100'}"><div><p class="font-bold uppercase tracking-tighter leading-none">${m} ${e.username}</p><p class="text-[9px] text-gray-400 uppercase mt-1 leading-none">${e.total_answered} Solved</p></div><p class="text-lg font-black text-orange-600">${e.streak_count}üî•</p></div>`})}
function toggleSignupMode(s){document.getElementById('reg-fields').classList.toggle('hidden',!s);['signin-btn','signup-toggle'].forEach(i=>document.getElementById(i).classList.toggle('hidden',s));['signup-confirm','back-to-login'].forEach(i=>document.getElementById(i).classList.toggle('hidden',!s))}
</script>
</body>
</html>